<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© N One | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --success: #25d366;
            --danger: #e74c3c;
            --warning: #f39c12;
            --bg: #f4f7f6;
            --white: #ffffff;
            --radius: 15px;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; min-height: 100vh; justify-content: center; overflow-x: hidden; }
        
        #loginSection { 
            background: var(--white); 
            padding: 30px; 
            border-radius: var(--radius); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            width: 90%; 
            max-width: 380px; 
            text-align: center; 
            border-top: 5px solid var(--primary); 
            box-sizing: border-box; 
        }
        #loginSection h1 { color: #2c3e50; margin-bottom: 25px; font-size: clamp(20px, 5vw, 24px); }
        
        #mainPage { display: none; background: var(--white); padding: 25px; border-radius: var(--radius); box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 95%; max-width: 500px; text-align: center; position: relative; box-sizing: border-box; }
        
        .settings-icon { position: absolute; top: 20px; left: 20px; cursor: pointer; font-size: 26px; z-index: 1000; color: #7f8c8d; }
        #settingsPanel { display: none; background: var(--white); padding: 25px; border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 2000; text-align: right; overflow-y: auto; }
        .dashboard-grid { display: flex; gap: 12px; margin-bottom: 25px; }
        .stat-card { flex: 1; background: #eef2f3; padding: 15px; border-radius: 12px; border-right: 5px solid var(--primary); }
        input { width: 100%; padding: 14px; margin: 8px 0; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; text-align: right; direction: rtl; outline: none; font-size: 16px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 17px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        .btn-send { background-color: var(--success); color: white; }
        .btn-login { background-color: var(--primary); color: white; }
        .settings-btn { background-color: var(--primary); color: white; margin-bottom: 8px; width: 100%; }
        .chart-container { width: 100%; height: 200px; margin-top: 20px; }
        .table-wrapper { width: 100%; overflow-x: auto; margin-top: 15px; }
        .all-orders-table { width: 100%; min-width: 600px; border-collapse: collapse; font-size: 12px; }
        .all-orders-table th, .all-orders-table td { padding: 8px; border: 1px solid #eee; text-align: center; }
        .all-orders-table th { background-color: var(--primary); color: white; }
        .edit-btn { background-color: var(--warning); color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 10px; }
        .delete-btn { background-color: var(--danger); color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 10px; margin-right: 5px; }
        .btn-logout { background-color: #7f8c8d; color: white; }
        @media (max-width: 480px) { #loginSection { padding: 25px 20px; } .container { padding: 15px; } .stat-card { padding: 10px; font-size: 14px; } }
    </style>
</head>
<body>

    <div id="loginSection">
        <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ | N One</h1>
        <input type="text" id="userInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="passInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn-login" onclick="validateLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>

    <div id="mainPage" class="container">
        <div class="settings-icon" onclick="toggleSettings()">âš™ï¸</div>
        <div id="settingsPanel">
            <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h3>
            <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:</label>
            <input type="number" id="globalCommission" step="0.01" value="0.30">
            <button class="settings-btn" onclick="showSection('chart')">Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</button>
            <button class="settings-btn" onclick="showSection('archive')">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ</button>
            <button class="settings-btn" onclick="showSection('monthly')">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¬Ø±Ø¯</button>
            <div id="chartSec" class="chart-container" style="display:none;"><canvas id="revenueChart"></canvas></div>
            <div id="dataSec" style="display:none;">
                <h4 id="secTitle"></h4>
                <div id="secTotal" style="font-weight:bold; color:#2980b9; margin-bottom:10px;"></div>
                <div class="table-wrapper">
                    <table class="all-orders-table"><thead id="secHead"></thead><tbody id="secBody"></tbody></table>
                </div>
            </div>
            <button style="background-color: var(--danger); color:white;" onclick="toggleSettings()">Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            <button class="btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>

        <h2 style="color: var(--primary); margin-bottom: 20px;">Ù„ÙˆØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª N One</h2>
        <div class="dashboard-grid">
            <div class="stat-card"><small>ØµØ§ÙÙŠ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…</small><div id="dailyProfit" style="font-weight: bold;">0.00 Ø¯.Ø£</div></div>
            <div class="stat-card"><small>Ø£Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ Ø´Ù‡Ø±ÙŠ</small><div id="topCaptain" style="font-weight: bold;">-</div></div>
        </div>
        <input type="tel" id="phoneInput" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨" oninput="searchCaptainInfo()">
        <input type="text" id="nameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨">
        <input type="text" id="locationInput" placeholder="Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©)">
        <input type="number" id="deliveryInput" placeholder="Ø£Ø¬Ø±Ø© Ø§Ù„ØªÙˆØµÙŠÙ„">
        <input type="number" id="priceInput" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø´Ø­Ù†Ø©">
        <button class="btn-send" onclick="processOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</button>
    </div>

<script>
    // Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
    const SHEETDB_API_URL = 'https://sheetdb.io/api/v1/xsp51h4e6tvnw';

    function validateLogin() {
        const u = document.getElementById('userInput').value;
        const p = document.getElementById('passInput').value;
        if(u === "admin" && p === "n1_2026") { sessionStorage.setItem('n1_auth', 'true'); showSystem(); }
        else { alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø¨ÙˆØ²Ù† Ø¨Ù„Ø¯ ğŸ˜Š"); }
    }
    function showSystem() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainPage').style.display = 'block';
        document.body.style.justifyContent = 'flex-start';
        updateDashboard();
        syncFromCloud(); // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ø¸Ø§Ù…
    }
    function logout() { sessionStorage.removeItem('n1_auth'); window.location.replace(window.location.pathname); }
    if(sessionStorage.getItem('n1_auth') === 'true') { showSystem(); }

    let allOrders = JSON.parse(localStorage.getItem('n1_orders')) || [];
    let myChart;

    function toggleSettings() {
        let p = document.getElementById('settingsPanel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
        if(p.style.display === 'none') updateDashboard();
    }

    function showSection(type) {
        document.getElementById('chartSec').style.display = type === 'chart' ? 'block' : 'none';
        document.getElementById('dataSec').style.display = type !== 'chart' ? 'block' : 'none';
        if(type === 'chart') renderChart();
        if(type === 'archive') updateArchive();
        if(type === 'monthly') updateMonthly();
    }

    function updateArchive() {
        document.getElementById('secTitle').innerText = "Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„Ø­Ø§Ù„ÙŠ)";
        document.getElementById('secHead').innerHTML = "<tr><th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>";
        let b = document.getElementById('secBody'); b.innerHTML = "";
        let today = new Date().toLocaleDateString('ar-EG');
        allOrders.slice().reverse().filter(o => o.date === today).forEach(o => {
            b.innerHTML += `<tr><td>${o.time}</td><td>${o.name}</td><td>${o.location}</td><td>
                <span class="edit-btn" onclick="editOrder(${o.id})">ØªØ¹Ø¯ÙŠÙ„</span>
                <span class="delete-btn" onclick="deleteOrder(${o.id})">Ø­Ø°Ù</span>
            </td></tr>`;
        });
    }

    function editOrder(id) {
        let o = allOrders.find(x => x.id === id);
        let nD = prompt("ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©:", o.delivery);
        if(nD !== null) { o.delivery = parseFloat(nD) || 0; localStorage.setItem('n1_orders', JSON.stringify(allOrders)); updateArchive(); updateDashboard(); }
    }

    function deleteOrder(id) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠØŸ")) {
            allOrders = allOrders.filter(x => x.id !== id);
            localStorage.setItem('n1_orders', JSON.stringify(allOrders));
            updateArchive(); updateDashboard();
        }
    }

    function updateMonthly() {
        document.getElementById('secTitle').innerText = "Ø§Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© ÙˆØ§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø¹Ø§Ù…";
        document.getElementById('secHead').innerHTML = "<tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th><th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th></tr>";
        let b = document.getElementById('secBody'); b.innerHTML = "";
        let s = {}, t = 0;
        allOrders.forEach(o => {
            let key = `${o.date}_${o.phone}`;
            let p = parseFloat(o.lockedCommission) || 0.3;
            t += p;
            if(!s[key]) s[key] = {d: o.date, n: o.name, c: 0, p: 0};
            s[key].c++; s[key].p += p;
        });
        document.getElementById('secTotal').innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ«Ù‚Ø©: ${t.toFixed(2)} Ø¯.Ø£`;
        Object.values(s).reverse().forEach(item => {
            b.innerHTML += `<tr><td>${item.d}</td><td>${item.n}</td><td>${item.c}</td><td>${item.p.toFixed(2)}</td></tr>`;
        });
    }

    function renderChart() {
        let ctx = document.getElementById('revenueChart').getContext('2d');
        let lbs = [...Array(7)].map((_, i) => { let d = new Date(); d.setDate(d.getDate() - i); return d.toLocaleDateString('ar-EG'); }).reverse();
        let dt = lbs.map(l => allOrders.filter(o => o.date === l).reduce((sm, o) => sm + (parseFloat(o.lockedCommission) || 0.3), 0));
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'line', data: { labels: lbs, datasets: [{ label: 'Ù…Ø¤Ø´Ø± Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…Ø§Ù„ÙŠ', data: dt, borderColor: '#3498db', fill: true, backgroundColor: 'rgba(52, 152, 219, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false } });
    }

    function searchCaptainInfo() {
        let phInput = document.getElementById('phoneInput');
        let nmInput = document.getElementById('nameInput');
        let val = phInput.value.trim();
        let found = allOrders.slice().reverse().find(o => o.phone === val);
        if(found) { nmInput.value = found.name; }
    }

    async function processOrder() {
        let ph = document.getElementById('phoneInput'), nm = document.getElementById('nameInput'), lc = document.getElementById('locationInput'), dl = document.getElementById('deliveryInput'), pr = document.getElementById('priceInput'), cm = document.getElementById('globalCommission');
        if(!ph.value || !lc.value) { alert("Ø®Ø·Ø£: ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªÙƒÙ…Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©."); return; }
        
        let mapLink = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(lc.value);
        let entry = { 
            id: Date.now(), 
            timestamp: new Date().getTime(), 
            date: new Date().toLocaleDateString('ar-EG'), 
            time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }), 
            name: nm.value || "Ù…Ù†Ø¯ÙˆØ¨ Ù…Ø¹ØªÙ…Ø¯", 
            phone: ph.value, 
            location: lc.value, 
            delivery: parseFloat(dl.value) || 0, 
            price: parseFloat(pr.value) || 0, 
            lockedCommission: parseFloat(cm.value) || 0.30, 
            mapLink: mapLink 
        };
        
        // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ ÙƒÙ…Ø§ ÙƒØ§Ù† Ø³Ø§Ø¨Ù‚Ø§Ù‹
        allOrders.push(entry); 
        localStorage.setItem('n1_orders', JSON.stringify(allOrders));

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø­Ø§Ø¨ÙŠØ© (Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©)
        try {
            fetch(SHEETDB_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: [entry] })
            });
        } catch(e) { console.log("Cloud Sync Error"); }
        
        let cO = allOrders.filter(o => o.phone === entry.phone && o.date === entry.date);
        let msg = `Ø¥Ø´Ø¹Ø§Ø± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - Ù…Ù†ØµØ© N One\n--------------------------\nØ§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡: ${entry.name}\nÙŠØ±Ø¬Ù‰ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ:\n\nØ§Ù„Ù…ØµØ¯Ø±: ${entry.location}\nØ§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ: ${entry.mapLink}\n\nØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„:\n- Ø£Ø¬Ø±Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${entry.delivery} Ø¯.Ø£\n- Ù‚ÙŠÙ…Ø© Ø§Ù„Ø´Ø­Ù†Ø©: ${entry.price} Ø¯.Ø£\n\nÙ…Ù„Ø®Øµ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ:\n- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: (${cO.length})\n- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª: ${cO.reduce((s,o)=>s+o.delivery,0).toFixed(2)} Ø¯.Ø£\n\nÙ†Ø±Ø¬Ùˆ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„ÙˆÙ‚Øª.`;
        
        let fP = entry.phone.startsWith('0') ? '962' + entry.phone.substring(1) : (entry.phone.startsWith('962') ? entry.phone : '962' + entry.phone);
        window.open(`https://wa.me/${fP}?text=${encodeURIComponent(msg)}`, '_blank');
        ph.value = ""; nm.value = ""; lc.value = ""; dl.value = ""; pr.value = ""; updateDashboard();
    }

    async function syncFromCloud() {
        try {
            const response = await fetch(SHEETDB_API_URL);
            const data = await response.json();
            if(data && data.length > 0) {
                allOrders = data;
                localStorage.setItem('n1_orders', JSON.stringify(allOrders));
                updateDashboard();
            }
        } catch(e) { console.log("Load Error"); }
    }

    function updateDashboard() {
        let t = new Date().toLocaleDateString('ar-EG');
        let d = allOrders.filter(o => o.date === t).reduce((s,o)=>s+(parseFloat(o.lockedCommission)||0.3),0);
        document.getElementById('dailyProfit').innerText = d.toFixed(2) + " Ø¯.Ø£";
        let c = {}; 
        allOrders.filter(o => o.date === t).forEach(o => { if(o.name) c[o.name] = (c[o.name] || 0) + 1; });
        let top = Object.keys(c).reduce((a, b) => c[a] > c[b] ? a : b, "-");
        document.getElementById('topCaptain').innerText = top;
    }
    window.onload = updateDashboard;
</script>
</body>
</html>
